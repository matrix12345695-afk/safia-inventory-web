<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }

html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  background: #0f0f0f;
  color: #fff;
  font-family: system-ui;
}

.app {
  display: flex;
  flex-direction: column;
  height: 100vh;
  padding: 10px;
}

h1 {
  font-size: 17px;
  margin-bottom: 6px;
}

.input {
  width: 100%;
  padding: 7px;
  border-radius: 7px;
  border: none;
  margin-bottom: 6px;
  font-size: 12px;
}

.list {
  flex: 1;
  overflow-y: auto;
}

/* ===== –ì–†–£–ü–ü–´ ===== */
.group {
  background: #181818;
  border-radius: 8px;
  margin-bottom: 6px;
}

.group-header {
  padding: 8px;
  font-size: 13px;
  font-weight: 600;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
}

.group-header span {
  opacity: 0.6;
}

.group-items {
  display: none;
  padding: 6px;
}

.group.open .group-items {
  display: block;
}

/* ===== –¢–û–í–ê–† ===== */
.item {
  background: #1c1c1c;
  border-radius: 8px;
  padding: 6px;
  margin-bottom: 5px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.name {
  flex: 1;
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.btn-plus {
  width: 22px;
  height: 22px;
  border-radius: 5px;
  border: none;
  font-size: 14px;
  font-weight: bold;
  background: #2e2e2e;
  color: #fff;
}

input.add {
  width: 28px;
  height: 22px;
  text-align: center;
  font-size: 11px;
}

input.total {
  width: 28px;
  height: 22px;
  text-align: center;
  font-size: 11px;
  background: #fff;
  color: #000;
  font-weight: 600;
}

/* ===== –ö–ù–û–ü–ö–ò ===== */
.footer {
  display: flex;
  gap: 8px;
  margin-top: 6px;
}

.footer button {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  border: none;
  font-size: 13px;
  font-weight: 600;
}

.save-btn {
  background: #2ea043;
  color: #fff;
}

.clear-btn {
  background: #a02e2e;
  color: #fff;
}
</style>
</head>

<body>

<div class="app">
  <h1 id="title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h1>

  <input id="filename" class="input" placeholder="–ò–º—è —Ñ–∞–π–ª–∞">
  <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫">

  <div id="list" class="list"></div>

  <div class="footer">
    <button class="save-btn" onclick="saveInventory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="clear-btn" onclick="clearAll()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();
tg.disableVerticalSwipes();

const params = new URLSearchParams(location.search);
const section = params.get("section") || "default";
const STORAGE_KEY = `inventory_draft_${section}`;

const titles = {
  kitchen: "–ö—É—Ö–Ω—è",
  bar: "–ë–∞—Ä",
  shop: "–ú–∞–≥–∞–∑–∏–Ω",
  freezer: "–ú–æ—Ä–æ–∑–∏–ª–∫–∞"
};
document.getElementById("title").textContent =
  titles[section] || "–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è";

let data = [];
let values = {};

function saveDraft() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
}

function loadDraft() {
  try {
    values = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
  } catch {
    values = {};
  }
}

fetch(`./data/${section}.json`)
  .then(r => r.json())
  .then(json => {
    data = json;
    loadDraft();
    render(data, "");
  });

/* üîç –ü–û–ò–°–ö –° –ê–í–¢–û-–†–ê–°–ö–†–´–¢–ò–ï–ú –ì–†–£–ü–ü */
document.getElementById("search").addEventListener("input", e => {
  const q = e.target.value.trim().toLowerCase();
  render(data, q);
});

function render(groups, query) {
  const root = document.getElementById("list");
  root.innerHTML = "";

  groups.forEach(g => {
    const matchedItems = query
      ? g.items.filter(i => i.name.toLowerCase().includes(query))
      : g.items;

    if (query && matchedItems.length === 0) return;

    const gDiv = document.createElement("div");
    gDiv.className = "group";

    if (query) gDiv.classList.add("open");

    const header = document.createElement("div");
    header.className = "group-header";
    header.innerHTML = `${g.group} <span>${gDiv.classList.contains("open") ? "‚ñ≤" : "‚ñº"}</span>`;

    const itemsDiv = document.createElement("div");
    itemsDiv.className = "group-items";

    header.onclick = () => {
      gDiv.classList.toggle("open");
      header.querySelector("span").textContent =
        gDiv.classList.contains("open") ? "‚ñ≤" : "‚ñº";
    };

    matchedItems.forEach(it => {
      const key = it.article;
      const stored = values[key];
      const val = stored ? stored.qty : "";

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="name">${it.name}</div>
        <button class="btn-plus">+</button>
        <input class="add" type="number">
        <input class="total" type="number" value="${val}">
      `;

      const add = row.querySelector(".add");
      const total = row.querySelector(".total");

      row.querySelector(".btn-plus").onclick = () => {
        const a = parseFloat(add.value);
        if (isNaN(a)) return;
        const cur = parseFloat(total.value) || 0;
        const next = cur + a;
        total.value = next;

        values[key] = {
          article: it.article,
          name: it.name,
          group: g.group,
          qty: next
        };
        add.value = "";
        saveDraft();
      };

      total.oninput = () => {
        if (total.value === "") {
          delete values[key];
        } else {
          values[key] = {
            article: it.article,
            name: it.name,
            group: g.group,
            qty: parseFloat(total.value)
          };
        }
        saveDraft();
      };

      itemsDiv.appendChild(row);
    });

    gDiv.appendChild(header);
    gDiv.appendChild(itemsDiv);
    root.appendChild(gDiv);
  });
}

function saveInventory() {
  const filename = document.getElementById("filename").value.trim();
  if (!filename) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞");

  const items = Object.values(values);
  if (!items.length) return tg.showAlert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

  tg.showConfirm("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é?", ok => {
    if (!ok) return;
    tg.sendData(JSON.stringify({ section, filename, items }));
  });
}

function clearAll() {
  tg.showConfirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?", ok => {
    if (!ok) return;
    values = {};
    localStorage.removeItem(STORAGE_KEY);
    render(data, "");
  });
}
</script>

</body>
</html>
