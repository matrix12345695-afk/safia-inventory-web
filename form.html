<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</title>

<meta name="viewport"
content="width=device-width,
initial-scale=1,
maximum-scale=1,
minimum-scale=1,
user-scalable=no">

<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
*{box-sizing:border-box}
html,body{
  margin:0;padding:0;height:100%;
  background:#0f0f0f;color:#fff;
  font-family:system-ui;overflow:hidden;
}
.app{display:flex;flex-direction:column;height:100%;padding:10px}
h1{font-size:17px;margin:0 0 6px}
.input{
  width:100%;padding:10px;border-radius:8px;
  border:none;margin-bottom:8px;font-size:16px
}
.list{flex:1;overflow-y:auto;padding-bottom:90px}
.group{background:#181818;border-radius:10px;margin-bottom:8px}
.group-header{
  padding:10px;font-weight:600;
  display:flex;justify-content:space-between;cursor:pointer
}
.group-items{display:none;padding:8px}
.group.open .group-items{display:block}
.item{
  background:#1c1c1c;border-radius:10px;
  padding:8px;margin-bottom:6px;
  display:flex;gap:6px;align-items:center
}
.name{
  flex:1;white-space:nowrap;
  overflow:hidden;text-overflow:ellipsis
}
.btn-plus{
  width:30px;height:30px;border:none;
  border-radius:8px;background:#2e2e2e;color:#fff
}
input.add{
  width:60px;height:34px;text-align:center;
  border-radius:8px;font-size:16px
}
input.total{
  width:70px;height:34px;text-align:center;
  border-radius:8px;background:#fff;
  color:#000;font-weight:600;font-size:16px
}
.footer{
  position:fixed;bottom:0;left:0;right:0;
  display:flex;gap:8px;padding:12px;
  background:#0f0f0f;border-top:1px solid #222
}
.footer button{
  flex:1;padding:14px;border:none;
  border-radius:10px;font-weight:600;font-size:16px
}
.save-btn{background:#2ea043;color:#fff}
.clear-btn{background:#a02e2e;color:#fff}
</style>
</head>

<body>

<div class="app">
  <h1 id="title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h1>
  <input id="filename" class="input" placeholder="–ò–º—è —Ñ–∞–π–ª–∞">
  <input id="search" class="input" placeholder="–ü–æ–∏—Å–∫">
  <div id="list" class="list"></div>
</div>

<div class="footer">
  <button class="save-btn" onclick="saveInventory()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button class="clear-btn" onclick="clearAll()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.disableVerticalSwipes();

const SECTIONS=["shop","kitchen","bar","freezer"];
const params=new URLSearchParams(location.search);
let section=params.get("section");
if(!SECTIONS.includes(section)) section="shop";

const STORAGE_KEY=`inventory_${section}`;
const titles={
  shop:"–ú–∞–≥–∞–∑–∏–Ω",
  kitchen:"–ö—É—Ö–Ω—è",
  bar:"–ë–∞—Ä",
  freezer:"–ú–æ—Ä–æ–∑–∏–ª–∫–∞"
};

document.getElementById("title").textContent=titles[section];

let data=[];
let values={};

function saveDraft(){
  localStorage.setItem(STORAGE_KEY,JSON.stringify(values))
}
function loadDraft(){
  values=JSON.parse(localStorage.getItem(STORAGE_KEY)||"{}")
}

fetch(`./data/${section}.json?v=200`)
.then(r=>r.json())
.then(json=>{
  data=json;
  loadDraft();
  render(data,"");
});

document.getElementById("search").addEventListener("input",e=>{
  render(data,e.target.value.toLowerCase());
});

function render(groups,query){
  const root=document.getElementById("list");
  root.innerHTML="";
  groups.forEach(g=>{
    const items=query
      ? g.items.filter(i=>i.name.toLowerCase().includes(query))
      : g.items;

    if(query&&items.length===0)return;

    const gDiv=document.createElement("div");
    gDiv.className="group";

    const header=document.createElement("div");
    header.className="group-header";
    header.innerHTML=`${g.group}<span>‚ñº</span>`;
    header.onclick=()=>gDiv.classList.toggle("open");

    const itemsDiv=document.createElement("div");
    itemsDiv.className="group-items";

    items.forEach(it=>{
      const key=it.article+"|"+g.group;
      const val=values[key]?.qty||"";

      const row=document.createElement("div");
      row.className="item";
      row.innerHTML=`
        <div class="name">${it.name}</div>
        <button class="btn-plus">+</button>
        <input class="add" type="number">
        <input class="total" type="number" value="${val}">
      `;

      const add=row.querySelector(".add");
      const total=row.querySelector(".total");

      row.querySelector(".btn-plus").onclick=()=>{
        const a=parseFloat(add.value);
        if(isNaN(a))return;
        const next=(parseFloat(total.value)||0)+a;
        total.value=next;
        values[key]={
          article:it.article,
          group:g.group,
          qty:next
        };
        add.value="";
        saveDraft();
      };

      total.oninput=()=>{
        if(!total.value) delete values[key];
        else values[key]={
          article:it.article,
          group:g.group,
          qty:parseFloat(total.value)
        };
        saveDraft();
      };

      itemsDiv.appendChild(row);
    });

    gDiv.appendChild(header);
    gDiv.appendChild(itemsDiv);
    root.appendChild(gDiv);
  });
}

async function saveInventory(){

  const filename=document.getElementById("filename").value.trim();
  if(!filename)return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞");

  const items=Object.values(values);
  if(!items.length)return tg.showAlert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

  const payload={
    user_id: tg.initDataUnsafe.user.id,
    section,
    filename,
    items
  };

  try{

    const response=await fetch(
      "https://YOUR_NGROK_URL/save_inventory",
      {
        method:"POST",
        headers:{
          "Content-Type":"application/json"
        },
        body:JSON.stringify(payload)
      }
    );

    const result=await response.json();

    if(result.status==="ok"){
      tg.showAlert("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: "+result.count+" –ø–æ–∑–∏—Ü–∏–π");
    }else{
      tg.showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
    }

  }catch(e){
    tg.showAlert("–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º");
  }
}

function clearAll(){
  values={};
  localStorage.removeItem(STORAGE_KEY);
  render(data,"");
}
</script>

</body>
</html>
