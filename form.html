<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
* { box-sizing: border-box; }
html, body {
  margin: 0; padding: 0; height: 100%;
  background: #0f0f0f; color: #fff;
  font-family: system-ui;
}
.app {
  display: flex; flex-direction: column;
  height: 100vh; padding: 10px;
}
h1 { font-size: 17px; margin-bottom: 6px; }
.input {
  width: 100%; padding: 7px;
  border-radius: 7px; border: none;
  margin-bottom: 6px; font-size: 12px;
}
.list { flex: 1; overflow-y: auto; }
.item {
  background: #1c1c1c;
  border-radius: 8px;
  padding: 6px; margin-bottom: 5px;
  display: flex; align-items: center; gap: 4px;
}
.name {
  flex: 1; font-size: 12px;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.btn-plus {
  width: 24px; height: 24px;
  border-radius: 5px; border: none;
  font-size: 16px; font-weight: bold;
  background: #2e2e2e; color: #fff;
}
input.add {
  width: 40px; height: 24px;
  text-align: center; font-size: 12px;
}
input.total {
  width: 38px; height: 24px;
  text-align: center; font-size: 12px;
  background: #fff; color: #000; font-weight: 600;
}
</style>
</head>

<body>
<div class="app">
  <h1 id="title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</h1>
  <input id="filename" class="input" placeholder="–ò–º—è —Ñ–∞–π–ª–∞">
  <input class="input" placeholder="–ü–æ–∏—Å–∫" oninput="filterItems(this.value)">
  <div id="list" class="list"></div>
</div>

<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();
tg.disableVerticalSwipes();

tg.MainButton.setText("üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å");
tg.MainButton.show();

const params = new URLSearchParams(location.search);
const section = params.get("section") || "default";

/* üîê SESSION ID ‚Äî –ö–õ–Æ–ß –í–°–ï–ì–û */
let sessionId = sessionStorage.getItem("inventory_session");
if (!sessionId) {
  sessionId = crypto.randomUUID();
  sessionStorage.setItem("inventory_session", sessionId);
}

const STORAGE_KEY = `inventory_${section}_${sessionId}`;

const titles = {
  kitchen: "–ö—É—Ö–Ω—è",
  bar: "–ë–∞—Ä",
  shop: "–ú–∞–≥–∞–∑–∏–Ω",
  freezer: "–ú–æ—Ä–æ–∑–∏–ª–∫–∞"
};
document.getElementById("title").textContent =
  titles[section] || "–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è";

let allItems = [];
let values = {};

function saveDraft() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
}

function loadDraft() {
  const saved = localStorage.getItem(STORAGE_KEY);
  if (!saved) return;
  try { values = JSON.parse(saved) || {}; }
  catch { values = {}; }
}

fetch(`./data/${section}.json`)
  .then(r => r.json())
  .then(data => {
    allItems = data;
    loadDraft();
    render(allItems);
  });

function render(items) {
  const root = document.getElementById("list");
  root.innerHTML = "";
  items.forEach(it => {
    const div = document.createElement("div");
    const val = values[it.name] ?? "";
    div.className = "item";
    div.innerHTML = `
      <div class="name">${it.name}</div>
      <button class="btn-plus">+</button>
      <input class="add" type="number">
      <input class="total" type="number" value="${val}">
    `;
    const add = div.querySelector(".add");
    const total = div.querySelector(".total");
    div.querySelector(".btn-plus").onclick = () => {
      const a = parseFloat(add.value);
      if (isNaN(a)) return;
      const cur = parseFloat(total.value) || 0;
      total.value = cur + a;
      values[it.name] = cur + a;
      add.value = "";
      saveDraft();
    };
    total.oninput = () => {
      if (total.value === "") delete values[it.name];
      else values[it.name] = parseFloat(total.value);
      saveDraft();
    };
    root.appendChild(div);
  });
}

function filterItems(q) {
  q = q.toLowerCase();
  render(allItems.filter(i => i.name.toLowerCase().includes(q)));
}

/* üíæ SAVE */
tg.onEvent("mainButtonClicked", () => {
  const filename = document.getElementById("filename").value.trim();
  if (!filename) return tg.showAlert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞");

  const items = Object.entries(values).map(([name, qty]) => ({ name, qty }));
  if (!items.length) return tg.showAlert("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö");

  tg.showConfirm("–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—é?", ok => {
    if (!ok) return;

    tg.sendData(JSON.stringify({
      section,
      filename,
      session_id: sessionId,
      items
    }));

    /* üî• –ö–†–ò–¢–ò–ß–ù–û */
    sessionStorage.removeItem("inventory_session"); // –Ω–æ–≤–∞—è —Å–µ—Å—Å–∏—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –≤—Ö–æ–¥–µ
    values = {};
    localStorage.removeItem(STORAGE_KEY);
    render(allItems);
  });
});
</script>
</body>
</html>
