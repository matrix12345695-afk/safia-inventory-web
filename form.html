<script>
const tg = Telegram.WebApp;
tg.ready();
tg.expand();
tg.disableVerticalSwipes();

const SECTIONS = ["shop", "kitchen", "bar", "freezer"];
const params = new URLSearchParams(location.search);
let section = params.get("section");
if (!SECTIONS.includes(section)) section = "shop";

const STORAGE_KEY = `inventory_draft_${section}`;

const titles = {
  shop: "Магазин",
  kitchen: "Кухня",
  bar: "Бар",
  freezer: "Морозилка"
};

document.getElementById("title").textContent = titles[section];

let data = [];
let values = {};

function saveDraft() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(values));
}

function loadDraft() {
  try {
    values = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
  } catch {
    values = {};
  }
}

fetch(`./data/${section}.json`)
  .then(r => r.json())
  .then(json => {
    data = json;
    loadDraft();
    render(data, "");
  });

document.getElementById("search").addEventListener("input", e => {
  render(data, e.target.value.trim().toLowerCase());
});

function render(groups, query) {
  const root = document.getElementById("list");
  root.innerHTML = "";

  groups.forEach(g => {
    const items = query
      ? g.items.filter(i => i.name.toLowerCase().includes(query))
      : g.items;

    if (query && items.length === 0) return;

    const gDiv = document.createElement("div");
    gDiv.className = "group";
    if (query) gDiv.classList.add("open");

    const header = document.createElement("div");
    header.className = "group-header";
    header.innerHTML = `${g.group} <span>▼</span>`;

    const itemsDiv = document.createElement("div");
    itemsDiv.className = "group-items";

    header.onclick = () => {
      gDiv.classList.toggle("open");
      header.querySelector("span").textContent =
        gDiv.classList.contains("open") ? "▲" : "▼";
    };

    items.forEach(it => {
      const key = it.article + "|" + g.group; // ВАЖНО

      const val = values[key]?.qty || "";

      const row = document.createElement("div");
      row.className = "item";
      row.innerHTML = `
        <div class="name">${it.name}</div>
        <button class="btn-plus">+</button>
        <input class="add" type="number">
        <input class="total" type="number" value="${val}">
      `;

      const add = row.querySelector(".add");
      const total = row.querySelector(".total");

      row.querySelector(".btn-plus").onclick = () => {
        const a = parseFloat(add.value);
        if (isNaN(a)) return;

        const next = (parseFloat(total.value) || 0) + a;
        total.value = next;

        values[key] = {
          article: it.article,
          group: g.group,
          qty: next
        };

        add.value = "";
        saveDraft();
      };

      total.oninput = () => {
        if (!total.value) {
          delete values[key];
        } else {
          values[key] = {
            article: it.article,
            group: g.group,
            qty: parseFloat(total.value)
          };
        }
        saveDraft();
      };

      itemsDiv.appendChild(row);
    });

    gDiv.appendChild(header);
    gDiv.appendChild(itemsDiv);
    root.appendChild(gDiv);
  });
}

function saveInventory() {
  const filename = document.getElementById("filename").value.trim();
  if (!filename) return tg.showAlert("Введите имя файла");

  const compactItems = Object.values(values).map(v => ({
    article: v.article,
    group: v.group,
    qty: v.qty
  }));

  if (!compactItems.length) return tg.showAlert("Нет данных");

  const payload = JSON.stringify({
    section,
    filename,
    items: compactItems
  });

  if (payload.length > 60000) {
    return tg.showAlert("Слишком много данных. Разделите инвентаризацию.");
  }

  tg.showConfirm("Сохранить инвентаризацию?", ok => {
    if (ok) tg.sendData(payload);
  });
}

function clearAll() {
  tg.showConfirm("Очистить все данные?", ok => {
    if (!ok) return;
    values = {};
    localStorage.removeItem(STORAGE_KEY);
    render(data, "");
  });
}
</script>
